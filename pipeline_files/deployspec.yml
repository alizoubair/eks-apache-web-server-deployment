version: 0.2

phases:
  install:
    runtime-versions:
      python: 3.8
    commands:
      - echo "Installing AWS CLI..."
      - curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
      - unzip awscliv2.zip && ./aws/install
      - aws --version

      - echo "Installing kubectl..."
      - curl -LO "https://dl.k8s.io/release/$(curl -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
      - chmod +x kubectl && mv kubectl /usr/local/bin/
      - kubectl version --client

      - echo "Installing Helm..."
      - curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      - helm version

  pre_build:
    commands:
      - echo "Authenticating with EKS..."
      - aws eks update-kubeconfig --region $AWS_REGION --name $EKS_CLUSTER_NAME

      - echo "Installing EBS CSI driver addon..."
      - aws eks create-addon \
        --cluster-name $EKS_CLUSTER_NAME \
        --addon-name aws-ebs-csi-driver \
        --service-account-role-arn $CSI_DRIVER_ROLE_ARN \
        --region $AWS_REGION || echo "EBS CSI driver addon already exists or failed to install"

  build:
    commands:
      - echo "Deploying Prometheus monitoring stack..."
      - helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
      - helm repo update
      - helm upgrade --install monitoring prometheus-community/kube-prometheus-stack \
        --namespace monitoring --create-namespace \
        -f helm_charts/monitoring-values.yaml --timeout 10m

      - echo "Applying ADOT RBAC configuration..."
      - kubectl apply -f k8s-rbac/adot-rbac.yaml

      - echo "Deploying ADOT Collector..."
      - helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts
      - helm repo update
      - helm upgrade --install adot-collector open-telemetry/opentelemetry-collector \
        --namespace adot --create-namespace \
        -f helm_charts/adot-values.yaml

      - echo "Deploying Apache web server..."
      - helm upgrade --install apache-web-server helm_charts/apache-web-server \
        --namespace $K8S_NAMESPACE --create-namespace

  post_build:
    commands:
      - echo "All components deployed successfully."